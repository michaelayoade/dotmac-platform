# Production override â€” usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Hardens the base compose for production:
#   - Multi-worker uvicorn with proxy headers (for nginx/Caddy reverse proxy)
#   - Secure cookies (requires HTTPS termination upstream)
#   - Read-only root filesystem where possible
#   - Resource limits and reservations on all services
#   - Log rotation to prevent disk exhaustion
#   - PostgreSQL tuning for production workloads
#   - DB/Redis ports bound to localhost only

services:
  app:
    command:
      - "uvicorn"
      - "app.main:app"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8001"
      - "--workers"
      - "4"
      - "--proxy-headers"
      - "--forwarded-allow-ips"
      - "*"
      - "--access-log"
      - "--log-level"
      - "warning"
    environment:
      REFRESH_COOKIE_SECURE: "true"
      REFRESH_COOKIE_SAMESITE: "strict"
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    read_only: true
    tmpfs:
      - /tmp:size=100M

  worker:
    command:
      - "celery"
      - "-A"
      - "app.celery_app"
      - "worker"
      - "-l"
      - "warning"
      - "--concurrency"
      - "4"
      - "--max-tasks-per-child"
      - "1000"
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  beat:
    command:
      - "celery"
      - "-A"
      - "app.celery_app"
      - "beat"
      - "-l"
      - "warning"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    read_only: true
    tmpfs:
      - /tmp:size=50M

  db:
    ports:
      - "127.0.0.1:5436:5432"
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=768MB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "wal_level=replica"
      - "-c"
      - "max_wal_size=1GB"
      - "-c"
      - "log_min_duration_statement=500"
      - "-c"
      - "log_checkpoints=on"
      - "-c"
      - "log_connections=on"
      - "-c"
      - "log_disconnections=on"
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  redis:
    ports:
      - "127.0.0.1:6381:6379"
    command:
      - "redis-server"
      - "--requirepass"
      - "${REDIS_PASSWORD}"
      - "--maxmemory"
      - "512mb"
      - "--maxmemory-policy"
      - "allkeys-lru"
      - "--save"
      - ""
      - "--appendonly"
      - "no"
      - "--tcp-backlog"
      - "511"
      - "--loglevel"
      - "warning"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 768M
        reservations:
          cpus: "0.25"
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
