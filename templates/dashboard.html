{% extends "platform_base.html" %}
{% from "components/badges.html" import status_badge %}

{% block content %}
{% set testing = testing if testing is defined else false %}

{% if show_onboarding and onboarding_checklist %}
<!-- Onboarding Banner -->
<div id="onboarding-banner" class="mb-8 rounded-xl border border-primary-200/60 bg-gradient-to-r from-primary-50 to-amber-50 p-5 dark:border-primary-900/40 dark:from-primary-950/30 dark:to-amber-950/20">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-primary-500/10 dark:bg-primary-500/20">
                <svg class="h-5 w-5 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 0 0-2.455 2.456Z"/></svg>
            </div>
            <div>
                <h3 class="text-[14px] font-semibold text-surface-800 dark:text-surface-100">Getting started</h3>
                <p class="text-[12px] text-surface-500 dark:text-surface-400">{{ onboarding_checklist.completed_count }} of {{ onboarding_checklist.total_count }} steps completed</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- Progress mini-bar -->
            <div class="hidden sm:block w-32">
                <div class="h-1.5 w-full rounded-full bg-surface-200 dark:bg-surface-700">
                    <div class="h-1.5 rounded-full bg-primary-500 transition-all" style="width: {{ onboarding_checklist.percent }}%"></div>
                </div>
            </div>
            <a href="/onboarding" class="rounded-lg bg-surface-900 dark:bg-primary-500 px-3.5 py-2 text-[12px] font-medium text-white dark:text-surface-950 hover:bg-surface-800 dark:hover:bg-primary-400 transition">
                Continue
            </a>
            <form hx-post="/onboarding/dismiss" hx-swap="none" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button type="submit" class="rounded-md p-1.5 text-surface-400 hover:bg-surface-200/60 hover:text-surface-600 dark:hover:bg-surface-800 dark:hover:text-surface-300 transition" title="Dismiss">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </form>
        </div>
    </div>
</div>
<script>
    document.body.addEventListener('onboarding-dismissed', function() {
        var banner = document.getElementById('onboarding-banner');
        if (banner) banner.remove();
    });
</script>
{% endif %}

<!-- Stats Row -->
<div class="grid grid-cols-2 gap-4 sm:grid-cols-4 mb-10">
    <div class="group rounded-xl border border-surface-200/80 bg-white p-5 dark:border-surface-800/50 dark:bg-surface-900/80 card-lift">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Instances</p>
                <p class="mt-2 text-3xl font-display text-surface-900 dark:text-white">{{ stats.total_instances }}</p>
            </div>
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-surface-100 dark:bg-surface-800/80">
                <svg class="h-5 w-5 text-surface-400 dark:text-surface-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"/></svg>
            </div>
        </div>
    </div>

    <div class="group rounded-xl border border-surface-200/80 bg-white p-5 dark:border-surface-800/50 dark:bg-surface-900/80 card-lift">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Healthy</p>
                <p class="mt-2 text-3xl font-display text-emerald-600 dark:text-emerald-400">{{ stats.healthy }}</p>
            </div>
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-50 dark:bg-emerald-900/20">
                <svg class="h-5 w-5 text-emerald-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
            </div>
        </div>
    </div>

    <div class="group rounded-xl border border-surface-200/80 bg-white p-5 dark:border-surface-800/50 dark:bg-surface-900/80 card-lift">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Issues</p>
                <p class="mt-2 text-3xl font-display text-red-600 dark:text-red-400">{{ stats.unhealthy + stats.error }}</p>
            </div>
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-red-50 dark:bg-red-900/20">
                <svg class="h-5 w-5 text-red-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"/></svg>
            </div>
        </div>
    </div>

    <div class="group rounded-xl border border-surface-200/80 bg-white p-5 dark:border-surface-800/50 dark:bg-surface-900/80 card-lift">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Unknown</p>
                <p class="mt-2 text-3xl font-display text-amber-600 dark:text-amber-400">{{ stats.unknown }}</p>
            </div>
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-50 dark:bg-amber-900/20">
                <svg class="h-5 w-5 text-amber-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3h.007v.008H12v-.008ZM21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
            </div>
        </div>
    </div>
</div>

<div class="mb-8 flex flex-wrap items-center gap-2 text-[12px]">
    <a href="/instances" class="rounded-full border border-surface-200 px-3 py-1.5 text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">All Instances</a>
    <a href="/instances?health=unhealthy" class="rounded-full border border-red-200 px-3 py-1.5 text-red-600 hover:bg-red-50 dark:border-red-800/50 dark:text-red-400 dark:hover:bg-red-900/20 transition">
        Unhealthy ({{ stats.unhealthy }})
    </a>
    <a href="/instances?status=error" class="rounded-full border border-red-200 px-3 py-1.5 text-red-600 hover:bg-red-50 dark:border-red-800/50 dark:text-red-400 dark:hover:bg-red-900/20 transition">
        Errors ({{ stats.error }})
    </a>
    <a href="/instances?health=unknown" class="rounded-full border border-amber-200 px-3 py-1.5 text-amber-700 hover:bg-amber-50 dark:border-amber-800/60 dark:text-amber-400 dark:hover:bg-amber-900/20 transition">
        Unknown ({{ stats.unknown }})
    </a>
</div>

<!-- Instance Table -->
<div class="flex items-end justify-between mb-5">
    <div>
        <h2 class="text-2xl font-display text-surface-800 dark:text-surface-100">Instances</h2>
        <p class="mt-0.5 text-[13px] text-surface-400 dark:text-surface-500">All deployed ERP tenants</p>
    </div>
    <div class="flex items-center gap-3">
        <a href="/instances" class="rounded-lg border border-surface-200 px-4 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">View All</a>
        <a href="/instances/new" data-testid="dashboard-new-instance" class="inline-flex items-center gap-2 rounded-lg bg-surface-900 dark:bg-primary-500 px-4 py-2 text-[13px] font-medium text-white dark:text-surface-950 shadow-sm hover:bg-surface-800 dark:hover:bg-primary-400 transition">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
            New Instance
        </a>
    </div>
</div>

{% if instances %}
<div class="relative overflow-hidden rounded-xl border border-surface-200/80 bg-white dark:border-surface-800/50 dark:bg-surface-900/80"
     {% if not testing %}hx-trigger="every 30s" hx-get="/dashboard" hx-select="#instance-table" hx-target="#instance-table" hx-swap="outerHTML"{% endif %}>
    <div class="htmx-indicator absolute top-0 left-0 right-0 h-0.5 overflow-hidden z-20">
        <div class="h-full w-1/3 bg-primary-500 rounded-full htmx-progress-bar"></div>
    </div>
    <table id="instance-table" class="min-w-full divide-y divide-surface-100 dark:divide-surface-800/60">
        <thead>
            <tr class="bg-surface-50/80 dark:bg-surface-800/30">
                <th class="px-5 py-3 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Instance</th>
                <th class="px-5 py-3 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Status</th>
                <th class="px-5 py-3 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Health</th>
                <th class="px-5 py-3 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Port</th>
                <th class="px-5 py-3"></th>
            </tr>
        </thead>
        <tbody class="divide-y divide-surface-100/80 dark:divide-surface-800/40">
            {% for item in instances[:25] %}
            {% set inst = item.instance %}
            {% set health = item.health %}
            {% set health_state = item.health_state %}
            <tr class="hover:bg-surface-50/60 dark:hover:bg-surface-800/20 transition-colors">
                <td class="px-5 py-4">
                    <a href="/instances/{{ inst.instance_id }}" class="text-[13px] font-medium text-surface-900 hover:text-primary-600 dark:text-white dark:hover:text-primary-400 transition">{{ inst.org_code }}</a>
                    <p class="text-[11px] text-surface-400 dark:text-surface-500">{{ inst.org_name }}</p>
                </td>
                <td class="px-5 py-4">
                    {{ status_badge(inst.status.value) }}
                </td>
                <td class="px-5 py-4">
                    {% if health_state == 'healthy' %}
                        <span class="text-[12px] font-mono text-emerald-600 dark:text-emerald-400">{{ health.response_ms|default('--') }}ms</span>
                    {% elif health_state == 'unhealthy' %}
                        <span class="text-[12px] text-red-600 dark:text-red-400">Unhealthy</span>
                    {% else %}
                        <span class="text-[12px] text-amber-600 dark:text-amber-400">Unknown</span>
                    {% endif %}
                </td>
                <td class="px-5 py-4 text-[13px] text-surface-500 dark:text-surface-400 font-mono">:{{ inst.app_port }}</td>
                <td class="px-5 py-4 text-right">
                    <a href="/instances/{{ inst.instance_id }}" class="text-[13px] text-surface-400 hover:text-surface-600 dark:text-surface-500 dark:hover:text-surface-300 transition">&rarr;</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if instances|length > 25 %}
    <div class="flex items-center justify-between border-t border-surface-100 px-5 py-3 text-[12px] text-surface-400 dark:border-surface-800/60 dark:text-surface-500">
        <span>Showing 25 of {{ instances|length }} instances</span>
        <a href="/instances" class="text-primary-600 hover:text-primary-700 dark:text-primary-400 transition">View all</a>
    </div>
    {% endif %}
</div>
{% else %}
<div class="rounded-xl border border-dashed border-surface-300 bg-white/50 p-16 text-center dark:border-surface-700 dark:bg-surface-900/30">
    <svg class="mx-auto h-12 w-12 text-surface-300 dark:text-surface-600" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"/></svg>
    <h3 class="mt-5 text-base font-display text-surface-700 dark:text-surface-300">No instances yet</h3>
    <p class="mt-1.5 text-[13px] text-surface-400 dark:text-surface-500">Get started by adding a server and creating your first ERP instance.</p>
    <div class="mt-6 flex justify-center gap-3">
        <a href="/servers/new" class="rounded-lg border border-surface-200 px-4 py-2.5 text-[13px] font-medium text-surface-600 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">Add Server</a>
        <a href="/instances/new" class="rounded-lg bg-surface-900 dark:bg-primary-500 px-4 py-2.5 text-[13px] font-medium text-white dark:text-surface-950 hover:bg-surface-800 dark:hover:bg-primary-400 transition">New Instance</a>
    </div>
</div>
{% endif %}
{% endblock %}
