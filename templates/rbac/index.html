{% extends "platform_base.html" %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-display text-surface-800 dark:text-surface-100">RBAC</h1>
        <p class="text-[13px] text-surface-400 dark:text-surface-500">Roles, permissions, and assignments.</p>
    </div>
    <a href="/people" class="rounded-lg border border-surface-200 px-4 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">People</a>
</div>

<div class="grid gap-6 lg:grid-cols-[1fr_1fr]">
    <div class="rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-800 dark:text-white">Roles</h2>
        <form method="POST" action="/rbac/roles" class="mt-4 grid gap-3 sm:grid-cols-[1fr_1fr_auto_auto]">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <input type="text" name="name" placeholder="role name" required class="rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white" />
            <input type="text" name="description" placeholder="description" class="rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white" />
            <label class="inline-flex items-center gap-1.5 text-[13px] text-surface-600 dark:text-surface-400">
                <input type="checkbox" name="is_active" value="true" checked class="h-4 w-4 rounded border-surface-300 text-primary-600 focus:ring-primary-500" />
                Active
            </label>
            <button type="submit" class="rounded-lg bg-surface-900 dark:bg-primary-500 px-3 py-2 text-[13px] font-semibold text-white dark:text-surface-950">Add</button>
        </form>
        <div class="mt-4 space-y-2">
            {% for role in roles %}
            <div class="flex items-center justify-between rounded-lg border border-surface-200/80 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-800/50 dark:bg-surface-800/40">
                <div>
                    <a href="/rbac?role_id={{ role.id }}" class="font-medium text-surface-800 dark:text-surface-100 hover:text-primary-600 dark:hover:text-primary-400">{{ role.name }}</a>
                    <p class="text-[11px] text-surface-400 dark:text-surface-500">{{ role.description or "No description" }}</p>
                </div>
                {% if role.is_active %}
                <form method="POST" action="/rbac/roles/{{ role.id }}/deactivate">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <button type="submit" class="text-[12px] text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">Deactivate</button>
                </form>
                {% else %}
                <span class="text-[11px] text-surface-400">Inactive</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-800 dark:text-white">Permissions</h2>
        <form method="POST" action="/rbac/permissions" class="mt-4 grid gap-3 sm:grid-cols-[1fr_1fr_auto_auto]">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <input type="text" name="key" placeholder="permission.key" required class="rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white" />
            <input type="text" name="description" placeholder="description" class="rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white" />
            <label class="inline-flex items-center gap-1.5 text-[13px] text-surface-600 dark:text-surface-400">
                <input type="checkbox" name="is_active" value="true" checked class="h-4 w-4 rounded border-surface-300 text-primary-600 focus:ring-primary-500" />
                Active
            </label>
            <button type="submit" class="rounded-lg bg-surface-900 dark:bg-primary-500 px-3 py-2 text-[13px] font-semibold text-white dark:text-surface-950">Add</button>
        </form>
        <div class="mt-4 space-y-2">
            {% for perm in permissions %}
            <div class="flex items-center justify-between rounded-lg border border-surface-200/80 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-800/50 dark:bg-surface-800/40">
                <div>
                    <p class="font-medium text-surface-800 dark:text-surface-100">{{ perm.key }}</p>
                    <p class="text-[11px] text-surface-400 dark:text-surface-500">{{ perm.description or "No description" }}</p>
                </div>
                {% if perm.is_active %}
                <form method="POST" action="/rbac/permissions/{{ perm.id }}/deactivate">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <button type="submit" class="text-[12px] text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">Deactivate</button>
                </form>
                {% else %}
                <span class="text-[11px] text-surface-400">Inactive</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="mt-6 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
    <div class="flex items-center justify-between">
        <h2 class="text-lg font-display text-surface-800 dark:text-white">Role Permissions</h2>
        <span class="text-[12px] text-surface-400 dark:text-surface-500">
            Selected role: {{ selected_role.name if selected_role else "None" }}
        </span>
    </div>

    <form method="POST" action="/rbac/role-permissions" class="mt-4 flex flex-wrap items-end gap-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <div class="min-w-[220px]">
            <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Role</label>
            <select name="role_id" class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white">
                {% for role in roles %}
                <option value="{{ role.id }}" {% if selected_role_id_uuid == role.id %}selected{% endif %}>{{ role.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="min-w-[260px]">
            <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Permission</label>
            <select name="permission_id" class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white">
                {% for perm in permissions %}
                <option value="{{ perm.id }}">{{ perm.key }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="rounded-lg bg-surface-900 dark:bg-primary-500 px-3 py-2 text-[13px] font-semibold text-white dark:text-surface-950">Assign</button>
    </form>

    <div class="mt-4 space-y-2">
        {% if role_permissions %}
            {% for link in role_permissions %}
            {% set perm = perm_map.get(link.permission_id) %}
            <div class="flex items-center justify-between rounded-lg border border-surface-200/80 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-800/50 dark:bg-surface-800/40">
                <div>
                    <p class="font-medium text-surface-800 dark:text-surface-100">{{ perm.key if perm else link.permission_id }}</p>
                    <p class="text-[11px] text-surface-400 dark:text-surface-500">{{ perm.description if perm else "Permission" }}</p>
                </div>
                <form method="POST" action="/rbac/role-permissions/{{ link.id }}/delete">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <input type="hidden" name="role_id" value="{{ selected_role_id }}" />
                    <button type="submit" class="text-[12px] text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300">Remove</button>
                </form>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-[12px] text-surface-400 dark:text-surface-500">No permissions assigned.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
