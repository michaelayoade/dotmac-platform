{% extends "platform_base.html" %}
{% from "components/breadcrumb.html" import breadcrumb %}
{% from "components/buttons.html" import btn_submit, btn_secondary, btn_danger %}

{% block content %}
{% set testing = testing if testing is defined else false %}
<div class="mb-6 flex flex-wrap items-center justify-between gap-4" x-data="{ editing: false }">
    <div>
        {{ breadcrumb([
            {"label": "Servers", "url": "/servers"},
            {"label": server.name}
        ]) }}
    </div>
    <div class="flex gap-2">
        <form method="POST" action="/servers/{{ server.server_id }}/test"
              {% if not testing %}hx-post="/servers/{{ server.server_id }}/test" hx-target="#test-result" hx-swap="innerHTML" hx-indicator="#test-result .htmx-indicator"{% endif %}
              x-data="{ submitting: false }" @submit="submitting = true"
              @htmx:after-request.window="submitting = false">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="server-test-connection" :disabled="submitting"
                    :class="submitting && 'opacity-60 pointer-events-none'"
                    class="inline-flex items-center gap-2 rounded-lg border border-surface-200 px-3 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">
                <svg x-show="!submitting" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z"/></svg>
                <svg x-show="submitting" x-cloak class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span x-text="submitting ? 'Testing...' : 'Test Connection'"></span>
            </button>
        </form>
        <button type="button" @click="editing = !editing" data-testid="server-edit-toggle"
                class="inline-flex items-center gap-2 rounded-lg border border-surface-200 px-3 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125"/></svg>
            Edit
        </button>
        <form method="POST" action="/servers/{{ server.server_id }}/delete" onsubmit="return confirm('Delete this server?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="server-delete"
                    class="rounded-lg border border-red-200 px-3 py-2 text-[13px] font-medium text-red-600 hover:bg-red-50 dark:border-red-800/60 dark:text-red-400 dark:hover:bg-red-900/20 transition">Delete</button>
        </form>
    </div>

    {# Edit Form (collapsible) #}
    <div x-show="editing" x-cloak class="mt-4 w-full rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h3 class="text-base font-display text-surface-700 dark:text-surface-300 mb-4">Edit Server</h3>
        <form method="POST" action="/servers/{{ server.server_id }}/edit" class="grid gap-5 sm:grid-cols-2"
              x-data="{ submitting: false }" @submit="submitting = true">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <div>
                <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Name</label>
                <input type="text" name="name" value="{{ server.name }}" required class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
            </div>
            <div>
                <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Hostname</label>
                <input type="text" name="hostname" value="{{ server.hostname }}" required class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
            </div>
            <div>
                <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">SSH Port</label>
                <input type="number" name="ssh_port" value="{{ server.ssh_port }}" class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
            </div>
            <div>
                <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">SSH User</label>
                <input type="text" name="ssh_user" value="{{ server.ssh_user }}" class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
            </div>
            <div>
                <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">SSH Key Path</label>
                <input type="text" name="ssh_key_path" value="{{ server.ssh_key_path }}" class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
            </div>
            <div>
                <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Base Domain</label>
                <input type="text" name="base_domain" value="{{ server.base_domain or '' }}" class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
            </div>
            <div class="sm:col-span-2">
                <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Notes</label>
                <textarea name="notes" rows="3" class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition">{{ server.notes or '' }}</textarea>
            </div>
            <div class="sm:col-span-2 flex justify-end gap-3">
                <button type="button" @click="editing = false" class="rounded-lg border border-surface-200 px-4 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">Cancel</button>
                {{ btn_submit("Save Changes", submitting_text="Saving...", size="md") }}
            </div>
        </form>
    </div>
</div>

<div id="test-result" class="mb-6">
    <div class="htmx-indicator rounded-lg border border-surface-200/80 bg-white p-4 dark:border-surface-800/50 dark:bg-surface-900/80">
        <div class="flex items-center gap-3">
            <div class="h-4 w-4 skeleton rounded-full"></div>
            <div class="h-3 w-48 skeleton"></div>
        </div>
    </div>
</div>

<div class="grid gap-6 lg:grid-cols-2">
    <!-- Server Info -->
    <div class="rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-5">Server Details</h2>
        <dl class="space-y-3.5">
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Hostname</dt>
                <dd class="text-[13px] font-medium text-surface-900 dark:text-white font-mono">{{ server.hostname }}</dd>
            </div>
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">SSH</dt>
                <dd class="text-[13px] font-medium text-surface-900 dark:text-white font-mono">{{ server.ssh_user }}@{{ server.hostname }}:{{ server.ssh_port }}</dd>
            </div>
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Key Path</dt>
                <dd class="text-[12px] text-surface-500 dark:text-surface-400 font-mono">{{ server.ssh_key_path }}</dd>
            </div>
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">SSH Key</dt>
                <dd class="text-[12px] text-surface-500 dark:text-surface-400 font-mono">
                    {% if server.ssh_key_id and ssh_key %}
                        {% if ssh_key_label %}
                            <span class="text-surface-700 dark:text-surface-300">{{ ssh_key_label }}</span>
                            <span class="text-surface-400"> â€” </span>
                        {% endif %}
                        {{ ssh_key[:28] }}...
                    {% elif server.ssh_key_id %}
                        assigned
                    {% else %}
                        (none)
                    {% endif %}
                </dd>
            </div>
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Base Domain</dt>
                <dd class="text-[13px] text-surface-900 dark:text-white">{{ server.base_domain or '(none)' }}</dd>
            </div>
            <div class="flex justify-between items-center">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Type</dt>
                <dd>
                    {% if server.is_local %}
                        <span class="rounded-md bg-primary-50 px-2 py-0.5 text-[11px] font-medium text-primary-700 dark:bg-primary-900/20 dark:text-primary-400">Local</span>
                    {% else %}
                        <span class="rounded-md bg-surface-100 px-2 py-0.5 text-[11px] font-medium text-surface-500 dark:bg-surface-800 dark:text-surface-400">Remote</span>
                    {% endif %}
                </dd>
            </div>
            <div class="flex justify-between items-center">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Status</dt>
                <dd>
                    {% if server.status.value == 'connected' %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-emerald-600 dark:text-emerald-400"><span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>Connected</span>
                    {% elif server.status.value == 'unreachable' %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-red-600 dark:text-red-400"><span class="h-1.5 w-1.5 rounded-full bg-red-500"></span>Unreachable</span>
                    {% else %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-surface-400"><span class="h-1.5 w-1.5 rounded-full bg-surface-400"></span>Unknown</span>
                    {% endif %}
                </dd>
            </div>
            {% if server.last_connected %}
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Last Connected</dt>
                <dd class="text-[13px] text-surface-500 dark:text-surface-400">{{ server.last_connected.strftime('%Y-%m-%d %H:%M UTC') }}</dd>
            </div>
            {% endif %}
        </dl>
    </div>

    <!-- Instances on this server -->
    <div class="rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <div class="flex items-center justify-between mb-5">
            <h2 class="text-lg font-display text-surface-700 dark:text-surface-300">Instances <span class="text-surface-400">({{ instances | length }})</span></h2>
            <a href="/instances/new" class="text-[13px] text-primary-600 hover:text-primary-700 dark:text-primary-400 transition">+ New</a>
        </div>
        {% if instances %}
        <div class="space-y-2.5">
            {% for inst in instances %}
            <a href="/instances/{{ inst.instance_id }}" class="flex items-center justify-between rounded-lg border border-surface-100 p-3.5 hover:border-surface-200 transition dark:border-surface-800/60 dark:hover:border-surface-700">
                <div>
                    <p class="text-[13px] font-medium text-surface-900 dark:text-white">{{ inst.org_code }}</p>
                    <p class="text-[11px] text-surface-400 dark:text-surface-500">{{ inst.org_name }}</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[11px] text-surface-400 font-mono">:{{ inst.app_port }}</span>
                    {% if inst.status.value == 'running' %}
                        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                    {% elif inst.status.value == 'error' %}
                        <span class="h-2 w-2 rounded-full bg-red-500"></span>
                    {% else %}
                        <span class="h-2 w-2 rounded-full bg-surface-300 dark:bg-surface-600"></span>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-[13px] text-surface-400 dark:text-surface-500">No instances on this server yet.</p>
        {% endif %}
    </div>
</div>

{% if server.notes %}
<div class="mt-6 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
    <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-3">Notes</h2>
    <p class="text-[13px] text-surface-500 dark:text-surface-400 whitespace-pre-wrap leading-relaxed">{{ server.notes }}</p>
</div>
{% endif %}
{% endblock %}
