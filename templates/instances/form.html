{% extends "platform_base.html" %}
{% from "components/buttons.html" import btn_submit, btn_secondary %}

{% block content %}
<div class="mx-auto max-w-2xl">
    <div class="rounded-xl border border-surface-200/80 bg-white p-7 dark:border-surface-800/50 dark:bg-surface-900/80">
        <div class="mb-6">
            <h2 class="text-xl font-display text-surface-900 dark:text-white">New Instance</h2>
            <p class="mt-1 text-[13px] text-surface-400 dark:text-surface-500">Deploy a new tenant on a registered server.</p>
        </div>

        {% if errors %}
        <div class="mb-5 flex items-center gap-2.5 rounded-lg bg-red-50 px-4 py-3 text-[13px] text-red-700 dark:bg-red-900/20 dark:text-red-400">
            <svg class="h-4 w-4 shrink-0" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"/></svg>
            {% for e in errors %}{{ e }}{% endfor %}
        </div>
        {% endif %}

        <form method="POST" action="/instances/new" class="space-y-5" data-testid="instance-form"
              x-data="{ submitting: false, catalogMap: JSON.parse($el.dataset.catalogMap || '{}'), catalogSummary: null }"
              @submit="submitting = true"
              data-catalog-map='{{ catalog_map_json }}'>
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <div>
                <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Server</label>
                <select name="server_id" required data-testid="instance-server"
                        class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition">
                    <option value="">Select a server...</option>
                    {% for s in servers %}
                    <option value="{{ s.server_id }}">{{ s.name }} ({{ s.hostname }})</option>
                    {% endfor %}
                </select>
                {% if not servers %}
                <p class="mt-1.5 text-[11px] text-amber-600 dark:text-amber-400">No servers registered. <a href="/servers/new" class="underline">Add one first</a>.</p>
                {% endif %}
            </div>

            <div>
                <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Catalog Item</label>
                <select name="catalog_item_id" required data-testid="instance-catalog"
                        @change="catalogSummary = catalogMap[$event.target.value] || null"
                        class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition">
                    <option value="">Select a catalog item...</option>
                    {% for c in catalog_items %}
                    <option value="{{ c.catalog_id }}">{{ c.label }}</option>
                    {% endfor %}
                </select>
                <div x-show="catalogSummary" x-cloak class="mt-3 rounded-lg border border-surface-200/80 bg-surface-50 px-4 py-3 text-[12px] text-surface-600 dark:border-surface-700 dark:bg-surface-800/60 dark:text-surface-300">
                    <div class="flex flex-wrap items-center gap-2">
                        <span class="inline-flex items-center rounded-full bg-primary-100 px-2 py-0.5 text-[10px] font-semibold text-primary-700">Catalog Item</span>
                        <span class="font-medium" x-text="catalogSummary.label"></span>
                        <template x-if="catalogSummary.release_version">
                            <span class="text-surface-400">v<span x-text="catalogSummary.release_version"></span></span>
                        </template>
                    </div>
                    <div class="mt-2 grid gap-1 sm:grid-cols-3 text-[11px] text-surface-500 dark:text-surface-400">
                        <div>
                            <span class="uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Release</span>
                            <div class="font-medium" x-text="catalogSummary.release_name || '--'"></div>
                        </div>
                        <div>
                            <span class="uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Bundle</span>
                            <div class="font-medium" x-text="catalogSummary.bundle_name || '--'"></div>
                        </div>
                    </div>
                </div>
                {% if not catalog_items %}
                <p class="mt-1.5 text-[11px] text-amber-600 dark:text-amber-400">No catalog items configured. <a href="/catalog" class="underline">Create one first</a>.</p>
                {% endif %}
            </div>

            <div class="grid gap-5 sm:grid-cols-2">
                <div>
                    <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Organization Code</label>
                    <input type="text" name="org_code" required placeholder="ACME" pattern="[A-Za-z0-9_-]+" data-testid="instance-org-code"
                           class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] font-mono uppercase dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                    <p class="mt-1.5 text-[11px] text-surface-400 dark:text-surface-500">Unique identifier. Letters, numbers, hyphens only.</p>
                </div>
                <div>
                    <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Organization Name</label>
                    <input type="text" name="org_name" required placeholder="ACME Corporation" data-testid="instance-org-name"
                           class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                </div>
            </div>

            <details class="group rounded-lg border border-surface-200/80 dark:border-surface-800/50" x-data="{ open: false }">
                <summary class="cursor-pointer px-4 py-3 text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500 select-none list-none flex items-center gap-2" @click.prevent="open = !open">
                    <svg class="h-3.5 w-3.5 transition-transform" :class="open && 'rotate-90'" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/></svg>
                    ERP Configuration (optional)
                </summary>
                <div class="px-4 pb-4 pt-1 grid gap-5 sm:grid-cols-3" x-show="open" x-cloak>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Sector Type</label>
                        <select name="sector_type" data-testid="instance-sector"
                                class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition">
                            <option value="" selected>Not applicable</option>
                            <option value="PRIVATE">Private Sector</option>
                            <option value="PUBLIC">Public Sector</option>
                            <option value="NGO">NGO / Non-Profit</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Framework</label>
                        <select name="framework" data-testid="instance-framework"
                                class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition">
                            <option value="" selected>Not applicable</option>
                            <option value="IFRS">IFRS</option>
                            <option value="IPSAS">IPSAS</option>
                            <option value="BOTH">Both</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Currency</label>
                        <input type="text" name="currency" value="" maxlength="3" data-testid="instance-currency"
                               class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] font-mono uppercase dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                    </div>
                </div>
            </details>

            <details class="group rounded-lg border border-surface-200/80 dark:border-surface-800/50" x-data="{ open: false }">
                <summary class="cursor-pointer px-4 py-3 text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500 select-none list-none flex items-center gap-2" @click.prevent="open = !open">
                    <svg class="h-3.5 w-3.5 transition-transform" :class="open && 'rotate-90'" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/></svg>
                    Custom Ports (optional)
                </summary>
                <div class="px-4 pb-4 pt-1 grid gap-5 sm:grid-cols-3" x-show="open" x-cloak>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">App Port</label>
                        <input type="number" name="app_port" placeholder="Auto" min="1" max="65535" data-testid="instance-app-port"
                               class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] font-mono dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">DB Port</label>
                        <input type="number" name="db_port" placeholder="Auto" min="1" max="65535" data-testid="instance-db-port"
                               class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] font-mono dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Redis Port</label>
                        <input type="number" name="redis_port" placeholder="Auto" min="1" max="65535" data-testid="instance-redis-port"
                               class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] font-mono dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                    </div>
                    <p class="sm:col-span-3 text-[11px] text-surface-400 dark:text-surface-500">Leave empty to auto-allocate ports from the server's pool.</p>
                </div>
            </details>

            <div class="grid gap-5 sm:grid-cols-2">
                <div>
                    <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Admin Username</label>
                    <input type="text" name="admin_username" value="admin" data-testid="instance-admin-username"
                           class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                </div>
                <div>
                    <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Admin Email (optional)</label>
                    <input type="email" name="admin_email" placeholder="admin@acme.com" data-testid="instance-admin-email"
                           class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                </div>
            </div>

            <div>
                <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Domain (optional)</label>
                <input type="text" name="domain" placeholder="acme.erp.dotmac.io" data-testid="instance-domain"
                       class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                <p class="mt-1.5 text-[11px] text-surface-400 dark:text-surface-500">Public domain for this instance. Caddy reverse proxy + SSL will be configured automatically during deployment.</p>
            </div>

            <div class="flex justify-end gap-3 pt-3 border-t border-surface-100 dark:border-surface-800/60">
                {{ btn_secondary("Cancel", href="/instances", size="lg") }}
                {{ btn_submit("Create Instance", submitting_text="Creating...", size="lg", testid="instance-submit") }}
            </div>
        </form>
    </div>
</div>
{% endblock %}
