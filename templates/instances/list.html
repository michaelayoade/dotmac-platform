{% extends "platform_base.html" %}
{% from "components/pagination.html" import pagination %}
{% from "components/badges.html" import status_badge %}
{% from "components/empty_state.html" import empty_state %}

{% block header_actions %}
<a href="/instances/new" class="inline-flex items-center gap-2 rounded-lg bg-surface-900 dark:bg-primary-500 px-3.5 py-1.5 text-[13px] font-medium text-white dark:text-surface-950 hover:bg-surface-800 dark:hover:bg-primary-400 transition shadow-sm">
    <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
    New Instance
</a>
{% endblock %}

{% block content %}
{% set active_filters = (q != '') | int + (status_filter != '') | int + (health_filter != '') | int + (sort != 'org_code') | int + (sort_dir != 'asc') | int %}
<form method="GET" action="/instances" class="mb-6 flex flex-wrap items-end gap-3">
    <input type="hidden" name="view" value="{{ view }}" />
    <div class="flex-1 min-w-[220px]">
        <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Search</label>
        <input type="text" name="q" value="{{ q }}" placeholder="Search org code or name"
               class="mt-1.5 w-full rounded-lg border border-surface-200 bg-white px-3 py-2 text-[13px] text-surface-700 focus:border-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-200/50 dark:border-surface-800 dark:bg-surface-900 dark:text-surface-200 dark:focus:ring-primary-500/20 transition" />
    </div>
    <div>
        <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Status</label>
        <select name="status" class="mt-1.5 rounded-lg border border-surface-200 bg-white px-3 py-2 text-[13px] text-surface-700 dark:border-surface-800 dark:bg-surface-900 dark:text-surface-200">
            <option value="">All</option>
            {% for value in ["running", "deploying", "stopped", "error", "provisioned", "trial", "suspended", "archived"] %}
            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ value | title }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Health</label>
        <select name="health" class="mt-1.5 rounded-lg border border-surface-200 bg-white px-3 py-2 text-[13px] text-surface-700 dark:border-surface-800 dark:bg-surface-900 dark:text-surface-200">
            <option value="">All</option>
            {% for value in ["healthy", "unhealthy", "unknown", "n/a"] %}
            <option value="{{ value }}" {% if health_filter == value %}selected{% endif %}>{{ value | title }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label class="block text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Page Size</label>
        <select name="page_size" class="mt-1.5 rounded-lg border border-surface-200 bg-white px-3 py-2 text-[13px] text-surface-700 dark:border-surface-800 dark:bg-surface-900 dark:text-surface-200">
            {% for size in [10, 25, 50, 100] %}
            <option value="{{ size }}" {% if page_size == size %}selected{% endif %}>{{ size }}</option>
            {% endfor %}
        </select>
    </div>
    <input type="hidden" name="sort" value="{{ sort }}" />
    <input type="hidden" name="dir" value="{{ sort_dir }}" />
    <div class="flex items-center gap-2">
        <button type="submit" class="rounded-lg bg-surface-900 dark:bg-primary-500 px-4 py-2 text-[13px] font-semibold text-white dark:text-surface-950 hover:bg-surface-800 dark:hover:bg-primary-400 transition">Apply</button>
        <a href="/instances" class="relative rounded-lg border border-surface-200 px-4 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">
            Reset
            {% if active_filters > 0 %}
            <span class="absolute -top-1.5 -right-1.5 flex h-4 min-w-4 items-center justify-center rounded-full bg-primary-500 px-1 text-[9px] font-bold text-surface-950">{{ active_filters }}</span>
            {% endif %}
        </a>
    </div>
</form>

<div class="mb-3 flex flex-wrap items-center justify-between gap-3 text-[12px] text-surface-400 dark:text-surface-500">
    <span>Showing {{ instances | length }} of {{ total }} instances{% if active_filters > 0 %} <span class="ml-1.5 inline-flex items-center gap-1 rounded-md bg-primary-50 px-1.5 py-0.5 text-[10px] font-medium text-primary-700 dark:bg-primary-900/20 dark:text-primary-400"><svg class="h-2.5 w-2.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z"/></svg>{{ active_filters }} filter{{ 's' if active_filters > 1 }}</span>{% endif %}</span>
    <div class="flex items-center gap-2">
        <a href="?q={{ q | urlencode }}&status={{ status_filter }}&health={{ health_filter }}&page=1&page_size={{ page_size }}&sort={{ sort }}&dir={{ sort_dir }}&view=table"
           class="rounded-lg border px-3 py-1.5 {% if view == 'table' %}border-primary-300 bg-primary-50 text-primary-700 dark:border-primary-700/60 dark:bg-primary-900/20 dark:text-primary-300{% else %}border-surface-200 text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800{% endif %}">
            Table
        </a>
        <a href="?q={{ q | urlencode }}&status={{ status_filter }}&health={{ health_filter }}&page=1&page_size={{ page_size }}&sort={{ sort }}&dir={{ sort_dir }}&view=cards"
           class="rounded-lg border px-3 py-1.5 {% if view == 'cards' %}border-primary-300 bg-primary-50 text-primary-700 dark:border-primary-700/60 dark:bg-primary-900/20 dark:text-primary-300{% else %}border-surface-200 text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800{% endif %}">
            Cards
        </a>
    </div>
</div>

{% if instances %}
{% if view == "cards" %}
<div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
    {% for item in instances %}
    {% set inst = item.instance %}
    {% set health = item.health %}
    {% set health_state = item.health_state %}
    <a href="/instances/{{ inst.instance_id }}" class="group rounded-xl border border-surface-200/80 bg-white p-5 transition-all duration-200 hover:border-surface-300 dark:border-surface-800/50 dark:bg-surface-900/80 dark:hover:border-surface-700 card-lift">
        <div class="flex items-start justify-between">
            <div>
                <h3 class="text-base font-semibold text-surface-900 dark:text-white">{{ inst.org_code }}</h3>
                <p class="mt-0.5 text-[13px] text-surface-400 dark:text-surface-500">{{ inst.org_name }}</p>
                {% if item.catalog_label %}
                <p class="mt-1 text-[12px] text-surface-400 dark:text-surface-500">
                    {{ item.catalog_label }}{% if item.release_version %} • v{{ item.release_version }}{% endif %}
                </p>
                {% endif %}
            </div>
            <span class="text-[11px] font-mono text-surface-400 dark:text-surface-500">:{{ inst.app_port }}</span>
        </div>
        <div class="mt-4 flex flex-wrap gap-2 text-[11px]">
            <span class="rounded-md bg-surface-100 px-2 py-0.5 text-surface-500 dark:bg-surface-800 dark:text-surface-400">{{ inst.status.value | title }}</span>
            {% if inst.framework %}<span class="rounded-md bg-surface-100 px-2 py-0.5 text-surface-500 dark:bg-surface-800 dark:text-surface-400">{{ inst.framework.value }}</span>{% endif %}
            {% if inst.sector_type %}<span class="rounded-md bg-surface-100 px-2 py-0.5 text-surface-500 dark:bg-surface-800 dark:text-surface-400">{{ inst.sector_type.value }}</span>{% endif %}
        </div>
        <div class="mt-4 text-[12px]">
            {% if health_state == 'healthy' %}
                <span class="text-emerald-600 dark:text-emerald-400 font-mono">{{ health.response_ms }}ms</span>
            {% elif health_state == 'unhealthy' %}
                <span class="text-red-600 dark:text-red-400">Unhealthy</span>
            {% elif health_state == 'unknown' %}
                <span class="text-amber-600 dark:text-amber-400">Unknown</span>
            {% else %}
                <span class="text-surface-400 dark:text-surface-500">N/A</span>
            {% endif %}
        </div>
    </a>
    {% endfor %}
</div>
{% else %}
<div class="overflow-x-auto rounded-xl border border-surface-200/80 bg-white dark:border-surface-800/50 dark:bg-surface-900/80 max-h-[calc(100vh-280px)]">
    <table class="min-w-full divide-y divide-surface-100 dark:divide-surface-800/60">
        {% set base_sort_qs = "q=" ~ (q | urlencode) ~ "&status=" ~ status_filter ~ "&health=" ~ health_filter ~ "&page=1&page_size=" ~ page_size ~ "&view=" ~ view %}
        {% macro sort_th(key, label) %}
        {% set next_dir = "desc" if sort == key and sort_dir == "asc" else "asc" %}
        <th class="px-5 py-3 text-left">
            <a href="?{{ base_sort_qs }}&sort={{ key }}&dir={{ next_dir }}"
               class="group inline-flex items-center gap-1 text-[10px] font-semibold uppercase tracking-[0.15em] transition
                      {% if sort == key %}text-surface-700 dark:text-surface-200{% else %}text-surface-400 dark:text-surface-500 hover:text-surface-600 dark:hover:text-surface-400{% endif %}">
                {{ label }}
                {% if sort == key %}
                <svg class="h-3 w-3 {% if sort_dir == 'desc' %}rotate-180{% endif %} transition-transform" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"/></svg>
                {% else %}
                <svg class="h-3 w-3 opacity-0 group-hover:opacity-40 transition-opacity" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"/></svg>
                {% endif %}
            </a>
        </th>
        {% endmacro %}
        <thead class="sticky top-0 z-10">
            <tr class="bg-surface-50 dark:bg-surface-800/80 backdrop-blur-sm">
                {{ sort_th("org_code", "Instance") }}
                {{ sort_th("framework", "Framework") }}
                {{ sort_th("sector", "Sector") }}
                {{ sort_th("port", "Port") }}
                {{ sort_th("catalog", "Catalog") }}
                {{ sort_th("status", "Status") }}
                {{ sort_th("health", "Health") }}
                <th class="px-5 py-3"></th>
            </tr>
        </thead>
        <tbody class="divide-y divide-surface-100/80 dark:divide-surface-800/40">
            {% for item in instances %}
            {% set inst = item.instance %}
            {% set health = item.health %}
            {% set health_state = item.health_state %}
            <tr class="hover:bg-surface-50/60 dark:hover:bg-surface-800/20 transition-colors">
                <td class="px-5 py-4">
                    <a href="/instances/{{ inst.instance_id }}" class="text-[13px] font-medium text-surface-900 hover:text-primary-600 dark:text-white dark:hover:text-primary-400 transition">{{ inst.org_code }}</a>
                    <p class="text-[11px] text-surface-400 dark:text-surface-500">{{ inst.org_name }}</p>
                </td>
                <td class="px-5 py-4">
                    {% if inst.framework %}<span class="rounded-md bg-surface-100 px-2 py-0.5 text-[11px] font-medium text-surface-500 dark:bg-surface-800 dark:text-surface-400">{{ inst.framework.value }}</span>{% else %}<span class="text-[11px] text-surface-300 dark:text-surface-600">—</span>{% endif %}
                </td>
                <td class="px-5 py-4">
                    {% if inst.sector_type %}<span class="rounded-md bg-surface-100 px-2 py-0.5 text-[11px] font-medium text-surface-500 dark:bg-surface-800 dark:text-surface-400">{{ inst.sector_type.value }}</span>{% else %}<span class="text-[11px] text-surface-300 dark:text-surface-600">—</span>{% endif %}
                </td>
                <td class="px-5 py-4 text-[13px] text-surface-500 dark:text-surface-400 font-mono">:{{ inst.app_port }}</td>
                <td class="px-5 py-4">
                    {% if item.catalog_label %}
                        <div class="text-[12px] text-surface-700 dark:text-surface-300">{{ item.catalog_label }}</div>
                        {% if item.release_version %}
                            <div class="text-[11px] text-surface-400 dark:text-surface-500">v{{ item.release_version }}</div>
                        {% endif %}
                    {% else %}
                        <span class="text-[12px] text-surface-300 dark:text-surface-600">—</span>
                    {% endif %}
                </td>
                <td class="px-5 py-4">
                    {{ status_badge(inst.status.value) }}
                </td>
                <td class="px-5 py-4">
                    {% if health_state == 'healthy' %}
                        <span class="text-[12px] font-mono text-emerald-600 dark:text-emerald-400">{{ health.response_ms }}ms</span>
                    {% elif health_state == 'unhealthy' %}
                        <span class="text-[12px] text-red-600 dark:text-red-400">Unhealthy</span>
                    {% elif health_state == 'unknown' %}
                        <span class="text-[12px] text-amber-600 dark:text-amber-400">Unknown</span>
                    {% else %}
                        <span class="text-[12px] text-surface-300 dark:text-surface-600">N/A</span>
                    {% endif %}
                </td>
                <td class="px-5 py-4 text-right">
                    <a href="/instances/{{ inst.instance_id }}" class="text-[13px] text-surface-400 hover:text-surface-600 dark:text-surface-500 dark:hover:text-surface-300 transition">&rarr;</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{{ pagination(page=page, total=total, page_size=page_size, base_qs="q=" ~ (q | urlencode) ~ "&status=" ~ status_filter ~ "&health=" ~ health_filter ~ "&sort=" ~ sort ~ "&dir=" ~ sort_dir ~ "&view=" ~ view) }}
{% else %}
{{ empty_state(
    title="No instances yet",
    description="Create your first ERP instance to get started.",
    icon='<svg class="h-12 w-12 text-surface-300 dark:text-surface-600" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"/></svg>',
    action_label="New Instance",
    action_url="/instances/new"
) }}
{% endif %}
{% endblock %}
