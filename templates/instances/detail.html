{% extends "platform_base.html" %}
{% from "components/buttons.html" import btn_submit, btn_primary, btn_secondary, btn_danger, btn_success %}
{% from "components/breadcrumb.html" import breadcrumb %}

{% block content %}
{% set testing = testing if testing is defined else false %}
{# ===== HEADER: Breadcrumb + Org Name + Action Buttons ===== #}
<div class="mb-6 flex flex-wrap items-center justify-between gap-4">
    <div>
        {{ breadcrumb([
            {"label": "Instances", "url": "/instances"},
            {"label": instance.org_code}
        ]) }}
        <p class="mt-1 text-[13px] text-surface-400 dark:text-surface-500">{{ instance.org_name }}</p>
    </div>
    <div class="flex flex-wrap gap-2">
        {# Deploy button (provisioned/error only) #}
        {% if instance.status.value in ('provisioned', 'error') %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/deploy" class="inline"
              x-data="{ open: false, submitting: false }" @submit="submitting = true">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="button" @click="open = true" data-testid="instance-deploy-open"
                    class="inline-flex items-center gap-2 rounded-lg bg-surface-900 dark:bg-primary-500 px-3 py-2 text-[13px] font-semibold text-white dark:text-surface-950 hover:bg-surface-800 dark:hover:bg-primary-400 transition">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182"/></svg>
                Deploy
            </button>
            <!-- Deploy modal -->
            <div x-show="open" x-cloak
                 x-effect="document.body.classList.toggle('overflow-hidden', open)"
                 @keydown.escape.window="open = false"
                 class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
                 x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                 @click.self="open = false">
                <div class="w-full max-w-sm rounded-xl bg-white p-6 shadow-xl dark:bg-surface-800" @click.stop
                     x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95">
                    <h3 class="text-lg font-display text-surface-900 dark:text-white">Deploy {{ instance.org_code }}</h3>
                    <p class="mt-2 text-[13px] text-surface-400 dark:text-surface-500">This will run the full 10-step deployment pipeline.</p>
                    <div class="mt-4">
                        <label class="block text-[11px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Admin Password</label>
                        <input type="password" name="admin_password" placeholder="Enter admin password" required data-testid="instance-deploy-admin-password"
                               class="mt-1.5 w-full rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button type="button" @click="open = false" class="rounded-lg border border-surface-200 px-4 py-2 text-[13px] font-medium text-surface-500 dark:border-surface-700 dark:text-surface-400 hover:bg-surface-50 dark:hover:bg-surface-700 transition">Cancel</button>
                        {{ btn_submit("Start Deploy", submitting_text="Deploying...", size="md", testid="instance-deploy-submit") }}
                    </div>
                </div>
            </div>
        </form>
        {% endif %}

        {# Reconfigure button (running only) #}
        {% if instance.status.value == 'running' %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/reconfigure"
              x-data="{ submitting: false }" @submit.prevent="if(confirm('Reconfigure this instance? This will regenerate config files and restart services.')){submitting=true;$el.submit()}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="instance-reconfigure" :disabled="submitting"
                    :class="submitting && 'opacity-60 pointer-events-none'"
                    class="inline-flex items-center gap-2 rounded-lg border border-surface-200 px-3 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">
                <svg class="h-4 w-4" x-show="!submitting" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>
                <svg class="h-4 w-4 animate-spin" x-show="submitting" x-cloak fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span x-text="submitting ? 'Reconfiguring...' : 'Reconfigure'"></span>
            </button>
        </form>
        {% endif %}

        <a href="/observability/instances/{{ instance.instance_id }}/logs"
           class="inline-flex items-center gap-2 rounded-lg border border-surface-200 px-3 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 6.75h15m-15 4.5h15m-15 4.5h15"/></svg>
            Logs
        </a>

        {# Start / Stop / Restart buttons #}
        {% if instance.status.value == 'running' %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/restart"
              x-data="{ submitting: false }" @submit="submitting = true">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="instance-restart" :disabled="submitting"
                    :class="submitting && 'opacity-60 pointer-events-none'"
                    class="inline-flex items-center gap-2 rounded-lg border border-surface-200 px-3 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">
                <span x-text="submitting ? 'Restarting...' : 'Restart'"></span>
            </button>
        </form>
        <form method="POST" action="/instances/{{ instance.instance_id }}/stop" onsubmit="return confirm('Stop this instance?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            {{ btn_danger("Stop", testid="instance-stop", size="sm") }}
        </form>
        {% elif instance.status.value == 'stopped' %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/start"
              x-data="{ submitting: false }" @submit="submitting = true">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="instance-start" :disabled="submitting"
                    :class="submitting && 'opacity-60 pointer-events-none'"
                    class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-3 py-2 text-[13px] font-semibold text-white hover:bg-emerald-700 transition">
                <span x-text="submitting ? 'Starting...' : 'Start'"></span>
            </button>
        </form>
        {% endif %}

        {# Migrate button (running only) #}
        {% if instance.status.value == 'running' %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/migrate">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="instance-migrate"
                    class="inline-flex items-center gap-2 rounded-lg border border-surface-200 px-3 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125"/></svg>
                Migrate
            </button>
        </form>
        {% endif %}

        {# Suspend / Reactivate / Archive buttons based on status #}
        {% if instance.status.value in ('running', 'stopped') and not instance.suspended_at %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/suspend" onsubmit="return confirm('Suspend this instance? Users will lose access.')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="instance-suspend"
                    class="rounded-lg border border-amber-200 px-3 py-2 text-[13px] font-medium text-amber-600 hover:bg-amber-50 dark:border-amber-800/60 dark:text-amber-400 dark:hover:bg-amber-900/20 transition">Suspend</button>
        </form>
        {% endif %}
        {% if instance.status.value == 'suspended' or instance.suspended_at %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/reactivate">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="instance-reactivate"
                    class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-3 py-2 text-[13px] font-semibold text-white hover:bg-emerald-700 transition">Reactivate</button>
        </form>
        {% endif %}
        {% if instance.status.value in ('stopped', 'suspended', 'error') %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/archive" onsubmit="return confirm('Archive instance {{ instance.org_code }}? This will preserve data but make the instance inaccessible.')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="instance-archive"
                    class="rounded-lg border border-surface-200 px-3 py-2 text-[13px] font-medium text-surface-500 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-400 dark:hover:bg-surface-800 transition">Archive</button>
        </form>
        {% endif %}

        {# Delete button (stopped, error, provisioned, suspended) #}
        {% if instance.status.value in ('stopped', 'error', 'provisioned', 'suspended') %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/delete" onsubmit="return confirm('Delete instance {{ instance.org_code }}? This cannot be undone.')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" data-testid="instance-delete"
                    class="rounded-lg border border-red-200 px-3 py-2 text-[13px] font-medium text-red-600 hover:bg-red-50 dark:border-red-800/60 dark:text-red-400 dark:hover:bg-red-900/20 transition">Delete</button>
        </form>
        {% endif %}
    </div>
</div>

{# ===== TOP GRID: Instance Details + Health ===== #}
<div class="grid gap-6 lg:grid-cols-2">
    <!-- Instance Info -->
    <div class="rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-5">Instance Details</h2>
        <dl class="space-y-3.5">
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Org Code</dt>
                <dd class="text-[13px] font-medium text-surface-900 dark:text-white font-mono">{{ instance.org_code }}</dd>
            </div>
            <div class="flex justify-between items-center">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Framework</dt>
                <dd><span class="rounded-md bg-surface-100 px-2 py-0.5 text-[11px] font-medium text-surface-600 dark:bg-surface-800 dark:text-surface-400">{{ instance.framework.value }}</span></dd>
            </div>
            <div class="flex justify-between items-center">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Sector</dt>
                <dd><span class="rounded-md bg-surface-100 px-2 py-0.5 text-[11px] font-medium text-surface-600 dark:bg-surface-800 dark:text-surface-400">{{ instance.sector_type.value }}</span></dd>
            </div>
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Currency</dt>
                <dd class="text-[13px] text-surface-900 dark:text-white">{{ instance.currency }}</dd>
            </div>
            <div class="flex justify-between items-center">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Plan</dt>
                <dd>
                    {% if instance.plan %}
                        <span class="rounded-md bg-primary-50 px-2 py-0.5 text-[11px] font-medium text-primary-700 dark:bg-primary-900/30 dark:text-primary-400">{{ instance.plan.name }}</span>
                    {% else %}
                        <span class="text-[13px] text-surface-400">No plan</span>
                    {% endif %}
                </dd>
            </div>
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Version</dt>
                <dd class="text-[13px] font-mono text-surface-900 dark:text-white">
                    {% if instance.deployed_git_ref %}
                        {{ instance.deployed_git_ref[:12] }}
                    {% elif instance.git_tag %}
                        {{ instance.git_tag }}
                    {% elif instance.git_branch %}
                        {{ instance.git_branch }}
                    {% else %}
                        <span class="text-surface-400">--</span>
                    {% endif %}
                </dd>
            </div>
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Ports</dt>
                <dd class="text-[12px] text-surface-900 dark:text-white font-mono">App :{{ instance.app_port }} &middot; DB :{{ instance.db_port }} &middot; Redis :{{ instance.redis_port }}</dd>
            </div>
            {% if instance.domain %}
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Domain</dt>
                <dd class="text-[13px] text-primary-600 dark:text-primary-400">{{ instance.domain }}</dd>
            </div>
            {% endif %}
            {% if instance.app_url %}
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">URL</dt>
                <dd><a href="{{ instance.app_url }}" target="_blank" class="text-[13px] text-primary-600 hover:text-primary-700 dark:text-primary-400 transition">{{ instance.app_url }} &nearr;</a></dd>
            </div>
            {% endif %}
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Deploy Path</dt>
                <dd class="text-[12px] text-surface-500 dark:text-surface-400 font-mono">{{ instance.deploy_path or '(not set)' }}</dd>
            </div>
            <div class="flex flex-col gap-2">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Git Repository</dt>
                <dd class="text-[12px] text-surface-600 dark:text-surface-300">
                    {% if instance.git_repo_id %}
                        {% for r in repos %}
                            {% if r.repo_id == instance.git_repo_id %}
                                <span class="font-medium">{{ r.label }}</span> — <span class="text-surface-400">{{ r.url }}</span>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="text-surface-400">Platform default</span>
                    {% endif %}
                </dd>
                {% if not instance.catalog_item_id %}
                <form method="POST" action="/instances/{{ instance.instance_id }}/git-repo" class="flex flex-wrap items-center gap-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <select name="git_repo_id" required class="rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[12px] dark:border-surface-700 dark:bg-surface-800 dark:text-white">
                        <option value="">Select a repository...</option>
                        {% for r in repos %}
                        <option value="{{ r.repo_id }}" {% if instance.git_repo_id == r.repo_id %}selected{% endif %}>{{ r.label }} — {{ r.url }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="rounded-lg border border-surface-200 px-3 py-2 text-[12px] font-medium text-surface-600 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-300 dark:hover:bg-surface-800 transition">Update</button>
                </form>
                {% else %}
                <p class="text-[11px] text-surface-400">Managed by catalog release.</p>
                {% endif %}
            </div>
            <div class="flex flex-col gap-2">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Catalog Item</dt>
                <dd class="text-[12px] text-surface-600 dark:text-surface-300">
                    {% if instance.catalog_item_id %}
                        {% for c in catalog_items %}
                            {% if c.catalog_id == instance.catalog_item_id %}
                                <span class="font-medium">{{ c.label }}</span>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="text-surface-400">--</span>
                    {% endif %}
                </dd>
            </div>
            <div class="flex justify-between items-center">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Status</dt>
                <dd>
                    {% if instance.status.value == 'running' %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-emerald-600 dark:text-emerald-400"><span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>Running</span>
                    {% elif instance.status.value == 'deploying' %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-blue-600 dark:text-blue-400"><span class="h-1.5 w-1.5 rounded-full bg-blue-500 animate-pulse"></span>Deploying</span>
                    {% elif instance.status.value == 'error' %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-red-600 dark:text-red-400"><span class="h-1.5 w-1.5 rounded-full bg-red-500"></span>Error</span>
                    {% elif instance.status.value == 'stopped' %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-surface-500"><span class="h-1.5 w-1.5 rounded-full bg-surface-400"></span>Stopped</span>
                    {% elif instance.status.value == 'suspended' %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-amber-600 dark:text-amber-400"><span class="h-1.5 w-1.5 rounded-full bg-amber-500"></span>Suspended</span>
                    {% elif instance.status.value == 'archived' %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-surface-400"><span class="h-1.5 w-1.5 rounded-full bg-surface-300 dark:bg-surface-600"></span>Archived</span>
                    {% else %}
                        <span class="inline-flex items-center gap-1.5 text-[12px] font-medium text-amber-600 dark:text-amber-400"><span class="h-1.5 w-1.5 rounded-full bg-amber-400"></span>Provisioned</span>
                    {% endif %}
                </dd>
            </div>
            {% if instance.trial_expires_at %}
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Trial Expires</dt>
                <dd class="text-[13px] text-surface-500 dark:text-surface-400">{{ instance.trial_expires_at.strftime('%Y-%m-%d %H:%M UTC') }}</dd>
            </div>
            {% endif %}
            {% if instance.suspended_at %}
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Suspended At</dt>
                <dd class="text-[13px] text-amber-600 dark:text-amber-400">{{ instance.suspended_at.strftime('%Y-%m-%d %H:%M UTC') }}</dd>
            </div>
            {% endif %}
            <div class="flex justify-between items-baseline">
                <dt class="text-[13px] text-surface-400 dark:text-surface-500">Created</dt>
                <dd class="text-[13px] text-surface-500 dark:text-surface-400">{{ instance.created_at.strftime('%Y-%m-%d %H:%M UTC') }}</dd>
            </div>
        </dl>
    </div>

    <!-- Health -->
    <div class="rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <div class="flex items-center justify-between mb-5">
            <h2 class="text-lg font-display text-surface-700 dark:text-surface-300">Health</h2>
            <div class="relative" {% if not testing %}hx-get="/instances/{{ instance.instance_id }}/health" hx-trigger="every 30s" hx-swap="innerHTML"{% endif %}>
                <span class="htmx-indicator absolute inset-0 flex items-center justify-center"><span class="h-4 w-16 skeleton rounded-full"></span></span>
                {% if latest_health %}
                    {% if latest_health.status.value == 'healthy' %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-emerald-50 px-2.5 py-0.5 text-[11px] font-medium text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-400">
                            <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>Healthy &middot; {{ latest_health.response_ms }}ms
                        </span>
                    {% elif latest_health.status.value == 'unhealthy' %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-red-50 px-2.5 py-0.5 text-[11px] font-medium text-red-700 dark:bg-red-900/20 dark:text-red-400">
                            <span class="h-1.5 w-1.5 rounded-full bg-red-500"></span>Unhealthy
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-1.5 rounded-full bg-surface-100 px-2.5 py-0.5 text-[11px] font-medium text-surface-500 dark:bg-surface-800 dark:text-surface-400">Unreachable</span>
                    {% endif %}
                {% else %}
                    <span class="text-[11px] text-surface-400">No data</span>
                {% endif %}
            </div>
        </div>

        {# CPU / Memory / DB Size from latest health check #}
        {% if latest_health %}
        <div class="mb-5 grid grid-cols-3 gap-3">
            <div class="rounded-lg border border-surface-100 dark:border-surface-800/60 px-3 py-3 text-center">
                <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">CPU</p>
                <p class="mt-1 text-xl font-display text-surface-900 dark:text-white">
                    {% if latest_health.cpu_percent is not none %}{{ latest_health.cpu_percent }}%{% else %}--{% endif %}
                </p>
            </div>
            <div class="rounded-lg border border-surface-100 dark:border-surface-800/60 px-3 py-3 text-center">
                <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Memory</p>
                <p class="mt-1 text-xl font-display text-surface-900 dark:text-white">
                    {% if latest_health.memory_mb is not none %}{{ latest_health.memory_mb }} MB{% else %}--{% endif %}
                </p>
            </div>
            <div class="rounded-lg border border-surface-100 dark:border-surface-800/60 px-3 py-3 text-center">
                <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">DB Size</p>
                <p class="mt-1 text-xl font-display text-surface-900 dark:text-white">
                    {% if latest_health.db_size_mb is not none %}{{ latest_health.db_size_mb }} MB{% else %}--{% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        {% if recent_checks %}
        <div class="space-y-2">
            {% for check in recent_checks %}
            <div class="flex items-center justify-between rounded-lg border border-surface-100 dark:border-surface-800/60 px-3 py-2.5">
                <div class="flex items-center gap-2">
                    {% if check.status.value == 'healthy' %}
                        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                    {% elif check.status.value == 'unhealthy' %}
                        <span class="h-2 w-2 rounded-full bg-red-500"></span>
                    {% else %}
                        <span class="h-2 w-2 rounded-full bg-surface-300 dark:bg-surface-600"></span>
                    {% endif %}
                    <span class="text-[11px] font-mono text-surface-400 dark:text-surface-500">{{ check.checked_at.strftime('%H:%M:%S') if check.checked_at else '' }}</span>
                </div>
                <div class="flex items-center gap-3 text-[11px] text-surface-400 dark:text-surface-500">
                    {% if check.response_ms %}<span class="font-mono">{{ check.response_ms }}ms</span>{% endif %}
                    {% if check.db_healthy is not none %}
                        <span>DB: {% if check.db_healthy %}<span class="text-emerald-500">OK</span>{% else %}<span class="text-red-500">FAIL</span>{% endif %}</span>
                    {% endif %}
                    {% if check.redis_healthy is not none %}
                        <span>Redis: {% if check.redis_healthy %}<span class="text-emerald-500">OK</span>{% else %}<span class="text-red-500">FAIL</span>{% endif %}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-[13px] text-surface-400 dark:text-surface-500">No health checks recorded yet.</p>
        {% endif %}
    </div>
</div>

{# ===== DEPLOYMENT LOGS ===== #}
{% if deploy_logs %}
<div class="mt-6 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
    <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300">Latest Deployment</h2>
        {% if latest_deploy_id %}
        <a href="/instances/{{ instance.instance_id }}/deploy-log?deployment_id={{ latest_deploy_id }}" class="text-[13px] text-primary-600 hover:text-primary-700 dark:text-primary-400 transition">View Full Log &rarr;</a>
        {% endif %}
    </div>
    <div class="space-y-2">
        {% for log in deploy_logs %}
        <div class="flex items-center gap-3 rounded-lg border border-surface-100 dark:border-surface-800/60 px-3 py-2.5">
            {% if log.status.value == 'success' %}
                <svg class="h-5 w-5 flex-shrink-0 text-emerald-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
            {% elif log.status.value == 'failed' %}
                <svg class="h-5 w-5 flex-shrink-0 text-red-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
            {% elif log.status.value == 'running' %}
                <svg class="h-5 w-5 flex-shrink-0 text-blue-500 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            {% elif log.status.value == 'skipped' %}
                <svg class="h-5 w-5 flex-shrink-0 text-surface-300 dark:text-surface-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14"/></svg>
            {% else %}
                <span class="h-5 w-5 flex-shrink-0 rounded-full border-2 border-surface-200 dark:border-surface-700"></span>
            {% endif %}
            <div class="flex-1 min-w-0">
                <p class="text-[13px] font-medium text-surface-900 dark:text-white">{{ log.message }}</p>
            </div>
            {% if log.completed_at and log.started_at %}
            <span class="text-[11px] text-surface-400 font-mono">{{ (log.completed_at - log.started_at).total_seconds() | round(1) }}s</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{# ===== TABBED SECTIONS ===== #}
<div class="mt-6" x-data="{ activeTab: '{{ active_tab | default('modules') }}' }">
    {# Tab Navigation #}
    <div class="flex gap-1 rounded-xl border border-surface-200/80 bg-white p-1 dark:border-surface-800/50 dark:bg-surface-900/80">
        <button @click="activeTab = 'modules'" :class="activeTab === 'modules' ? 'bg-surface-900 text-white dark:bg-primary-500 dark:text-surface-950' : 'text-surface-500 hover:text-surface-700 dark:text-surface-400 dark:hover:text-surface-200'" class="rounded-lg px-4 py-2 text-[13px] font-medium transition">Modules</button>
        <button @click="activeTab = 'flags'" :class="activeTab === 'flags' ? 'bg-surface-900 text-white dark:bg-primary-500 dark:text-surface-950' : 'text-surface-500 hover:text-surface-700 dark:text-surface-400 dark:hover:text-surface-200'" class="rounded-lg px-4 py-2 text-[13px] font-medium transition">Feature Flags</button>
        <button @click="activeTab = 'plan'" :class="activeTab === 'plan' ? 'bg-surface-900 text-white dark:bg-primary-500 dark:text-surface-950' : 'text-surface-500 hover:text-surface-700 dark:text-surface-400 dark:hover:text-surface-200'" class="rounded-lg px-4 py-2 text-[13px] font-medium transition">Plan</button>
        <button @click="activeTab = 'upgrades'" :class="activeTab === 'upgrades' ? 'bg-surface-900 text-white dark:bg-primary-500 dark:text-surface-950' : 'text-surface-500 hover:text-surface-700 dark:text-surface-400 dark:hover:text-surface-200'" class="rounded-lg px-4 py-2 text-[13px] font-medium transition">Upgrades</button>
        <button @click="activeTab = 'backups'" :class="activeTab === 'backups' ? 'bg-surface-900 text-white dark:bg-primary-500 dark:text-surface-950' : 'text-surface-500 hover:text-surface-700 dark:text-surface-400 dark:hover:text-surface-200'" class="rounded-lg px-4 py-2 text-[13px] font-medium transition">Backups</button>
        <button @click="activeTab = 'secrets'" :class="activeTab === 'secrets' ? 'bg-surface-900 text-white dark:bg-primary-500 dark:text-surface-950' : 'text-surface-500 hover:text-surface-700 dark:text-surface-400 dark:hover:text-surface-200'" class="rounded-lg px-4 py-2 text-[13px] font-medium transition">Secrets</button>
        <button @click="activeTab = 'domains'" :class="activeTab === 'domains' ? 'bg-surface-900 text-white dark:bg-primary-500 dark:text-surface-950' : 'text-surface-500 hover:text-surface-700 dark:text-surface-400 dark:hover:text-surface-200'" class="rounded-lg px-4 py-2 text-[13px] font-medium transition">Domains</button>
        <button @click="activeTab = 'audit'" :class="activeTab === 'audit' ? 'bg-surface-900 text-white dark:bg-primary-500 dark:text-surface-950' : 'text-surface-500 hover:text-surface-700 dark:text-surface-400 dark:hover:text-surface-200'" class="rounded-lg px-4 py-2 text-[13px] font-medium transition">Audit Log</button>
    </div>

    {# ---- MODULES TAB ---- #}
    <div x-show="activeTab === 'modules'" x-cloak class="mt-4 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-5">Modules</h2>
        {% if modules %}
        <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
            {% for mod in modules %}
            <div class="flex items-center justify-between rounded-lg border border-surface-100 dark:border-surface-800/60 px-4 py-3">
                <div class="min-w-0">
                    <p class="text-[13px] font-medium text-surface-900 dark:text-white">{{ mod.module }}</p>
                    {% if mod.is_core %}
                    <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Core</p>
                    {% endif %}
                </div>
                {% if mod.is_core %}
                <div class="relative">
                    <div class="h-6 w-11 rounded-full bg-primary-500 opacity-60 cursor-not-allowed">
                        <span class="absolute left-[22px] top-0.5 h-5 w-5 rounded-full bg-white shadow transition"></span>
                    </div>
                </div>
                {% else %}
                <form method="POST" action="/instances/{{ instance.instance_id }}/modules/{{ mod.module_id }}/toggle">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <input type="hidden" name="enabled" value="{{ 'off' if mod.enabled else 'on' }}" />
                    <button type="submit" class="relative h-6 w-11 rounded-full transition {{ 'bg-primary-500' if mod.enabled else 'bg-surface-200 dark:bg-surface-700' }}">
                        <span class="absolute top-0.5 h-5 w-5 rounded-full bg-white shadow transition {{ 'left-[22px]' if mod.enabled else 'left-0.5' }}"></span>
                    </button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-[13px] text-surface-400 dark:text-surface-500">No modules configured for this instance.</p>
        {% endif %}
    </div>

    {# ---- FEATURE FLAGS TAB ---- #}
    <div x-show="activeTab === 'flags'" x-cloak class="mt-4 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-5">Feature Flags</h2>
        {% if flags %}
        <div class="space-y-3">
            {% for flag in flags %}
            <div class="flex items-center justify-between rounded-lg border border-surface-100 dark:border-surface-800/60 px-4 py-3">
                <div class="min-w-0 flex-1 mr-4">
                    <div class="flex items-center gap-2">
                        <p class="text-[13px] font-medium text-surface-900 dark:text-white font-mono">{{ flag.key }}</p>
                        {% if flag.is_custom %}
                        <span class="rounded bg-amber-100 px-1.5 py-0.5 text-[10px] font-medium text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">Custom</span>
                        {% endif %}
                    </div>
                    {% if flag.description %}
                    <p class="mt-0.5 text-[11px] text-surface-400 dark:text-surface-500">{{ flag.description }}</p>
                    {% endif %}
                </div>
                <form method="POST" action="/instances/{{ instance.instance_id }}/flags/{{ flag.key }}/toggle">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <input type="hidden" name="value" value="{{ 'false' if flag.value == 'true' else 'true' }}" />
                    <button type="submit" class="relative h-6 w-11 rounded-full transition {{ 'bg-primary-500' if flag.value == 'true' else 'bg-surface-200 dark:bg-surface-700' }}">
                        <span class="absolute top-0.5 h-5 w-5 rounded-full bg-white shadow transition {{ 'left-[22px]' if flag.value == 'true' else 'left-0.5' }}"></span>
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-[13px] text-surface-400 dark:text-surface-500">No feature flags configured for this instance.</p>
        {% endif %}
    </div>

    {# ---- PLAN TAB ---- #}
    <div x-show="activeTab === 'plan'" x-cloak class="mt-4 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-5">Subscription Plan</h2>
        {% if usage_summary %}
        <div class="mb-5 rounded-lg border border-surface-100 bg-surface-50/60 p-4 text-[12px] text-surface-600 dark:border-surface-800/60 dark:bg-surface-900/40 dark:text-surface-400">
            <div class="flex flex-wrap gap-4">
                <div>
                    <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Users</p>
                    <p class="font-mono">{{ usage_summary.current_users | round(2) }} / {{ usage_summary.max_users if usage_summary.max_users else '∞' }}</p>
                </div>
                <div>
                    <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Storage (GB)</p>
                    <p class="font-mono">{{ usage_summary.current_storage_gb | round(3) }} / {{ usage_summary.max_storage_gb if usage_summary.max_storage_gb else '∞' }}</p>
                </div>
                {% if usage_summary.users_percent is not none %}
                <div>
                    <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Users %</p>
                    <p class="font-mono">{{ (usage_summary.users_percent * 100) | round(1) }}%</p>
                </div>
                {% endif %}
                {% if usage_summary.storage_percent is not none %}
                <div>
                    <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Storage %</p>
                    <p class="font-mono">{{ (usage_summary.storage_percent * 100) | round(1) }}%</p>
                </div>
                {% endif %}
            </div>
            {% if compliance_violations %}
            <div class="mt-3 text-[11px] text-amber-600 dark:text-amber-400">
                {% for v in compliance_violations %}
                <div>• {{ v.message }}</div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% if plans %}
        <form method="POST" action="/instances/{{ instance.instance_id }}/plan"
              x-data="{ submitting: false }" @submit="submitting = true">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <div class="space-y-3">
                <label class="flex cursor-pointer items-start gap-4 rounded-lg border px-4 py-3.5 transition {{ 'border-primary-300 bg-primary-50/50 dark:border-primary-700/50 dark:bg-primary-950/20' if not instance.plan_id else 'border-surface-100 hover:border-surface-200 dark:border-surface-800/60 dark:hover:border-surface-700' }}">
                    <input type="radio" name="plan_id" value="" {{ 'checked' if not instance.plan_id else '' }} class="mt-1 h-4 w-4 border-surface-300 text-primary-600 focus:ring-primary-500" />
                    <div class="min-w-0 flex-1">
                        <p class="text-[13px] font-semibold text-surface-900 dark:text-white">No plan</p>
                        <p class="mt-0.5 text-[11px] text-surface-400 dark:text-surface-500">Remove the current plan assignment</p>
                    </div>
                </label>
                {% for plan in plans %}
                <label class="flex cursor-pointer items-start gap-4 rounded-lg border px-4 py-3.5 transition {{ 'border-primary-300 bg-primary-50/50 dark:border-primary-700/50 dark:bg-primary-950/20' if instance.plan_id == plan.plan_id else 'border-surface-100 hover:border-surface-200 dark:border-surface-800/60 dark:hover:border-surface-700' }}">
                    <input type="radio" name="plan_id" value="{{ plan.plan_id }}" {{ 'checked' if instance.plan_id == plan.plan_id else '' }} class="mt-1 h-4 w-4 border-surface-300 text-primary-600 focus:ring-primary-500" />
                    <div class="min-w-0 flex-1">
                        <p class="text-[13px] font-semibold text-surface-900 dark:text-white">{{ plan.name }}</p>
                        {% if plan.description %}
                        <p class="mt-0.5 text-[11px] text-surface-400 dark:text-surface-500">{{ plan.description }}</p>
                        {% endif %}
                    </div>
                </label>
                {% endfor %}
            </div>
            <div class="mt-5 flex justify-end">
                {{ btn_submit("Update Plan", submitting_text="Updating...", size="md", testid="instance-update-plan") }}
            </div>
        </form>
        {% else %}
        <p class="text-[13px] text-surface-400 dark:text-surface-500">No plans available.</p>
        {% endif %}
    </div>

    <div x-show="activeTab === 'upgrades'" x-cloak class="mt-4 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-5 flex items-center gap-2">
            Upgrades
            {% if pending_upgrade_ids %}
                <span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-700">Approval Pending</span>
            {% endif %}
        </h2>
        <form method="POST" action="/instances/{{ instance.instance_id }}/upgrades" class="grid gap-3 sm:grid-cols-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <select name="catalog_item_id" required class="rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white">
                <option value="">Select catalog item...</option>
                {% for c in catalog_items %}
                <option value="{{ c.catalog_id }}">{{ c.label }}</option>
                {% endfor %}
            </select>
            <input type="datetime-local" name="scheduled_for" class="rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white" />
            <button type="submit" class="rounded-lg bg-surface-900 px-4 py-2 text-[13px] font-semibold text-white dark:bg-primary-500 dark:text-surface-950">Schedule / Upgrade</button>
        </form>
        <p class="mt-2 text-[11px] text-surface-400">Leave schedule empty to run immediately.</p>

        <div class="mt-4">
            {% if upgrades %}
            <div class="overflow-x-auto">
                <table class="w-full text-[12px]">
                    <thead>
                        <tr class="border-b border-surface-100 dark:border-surface-800/60 text-left">
                            <th class="pb-2 pr-4 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Catalog Item</th>
                            <th class="pb-2 pr-4 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Version</th>
                            <th class="pb-2 pr-4 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Status</th>
                            <th class="pb-2 pr-4 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Scheduled</th>
                            <th class="pb-2 pr-4 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Created</th>
                            <th class="pb-2 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-surface-100 dark:divide-surface-800/60">
                        {% for u in upgrades %}
                        <tr>
                            {% set cat = catalog_map.get(u.catalog_item_id) %}
                            <td class="py-2 pr-4 text-surface-600">
                                {{ cat.label if cat else '--' }}
                            </td>
                            <td class="py-2 pr-4 text-surface-500">
                                {{ cat.release.version if cat and cat.release else '--' }}
                            </td>
                            <td class="py-2 pr-4 text-surface-500">
                                {{ u.status.value }}
                                {% if u.upgrade_id in pending_upgrade_ids %}
                                    <span class="ml-2 inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-[10px] font-semibold text-amber-700">Approval Pending</span>
                                {% endif %}
                                {% if u.status.value == 'cancelled' and u.cancelled_by_name %}
                                    <span class="ml-2 text-[10px] text-surface-400">by {{ u.cancelled_by_name }}</span>
                                {% endif %}
                            </td>
                            <td class="py-2 pr-4 text-surface-500">{{ u.scheduled_for.strftime('%Y-%m-%d %H:%M') if u.scheduled_for else '--' }}</td>
                            <td class="py-2 text-surface-500">{{ u.created_at.strftime('%Y-%m-%d %H:%M') if u.created_at else '--' }}</td>
                            <td class="py-2 text-right">
                                {% if u.status.value in ['scheduled', 'running'] %}
                                <form method="POST" action="/instances/{{ instance.instance_id }}/upgrades/{{ u.upgrade_id }}/cancel" class="inline-flex items-center gap-2">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                    <input type="text" name="reason" placeholder="Reason (optional)" class="rounded-lg border border-surface-200 bg-white px-2 py-1 text-[11px] dark:border-surface-700 dark:bg-surface-900 dark:text-surface-200" />
                                    <button type="submit" class="rounded-lg border border-amber-200 px-2 py-1 text-[11px] font-semibold text-amber-700 hover:bg-amber-50 dark:border-amber-800/60 dark:text-amber-400">Cancel</button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-[13px] text-surface-400">No upgrades scheduled.</p>
            {% endif %}
        </div>
    </div>

    {# ---- SECRETS TAB ---- #}
    <div x-show="activeTab === 'secrets'" x-cloak class="mt-4 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-5">Secrets Rotation</h2>
        <div class="grid gap-4 lg:grid-cols-2">
            <div class="rounded-lg border border-surface-100 p-4 dark:border-surface-800/60">
                <p class="text-[12px] text-surface-500 dark:text-surface-400">Rotate a single secret</p>
                <form method="POST" action="/instances/{{ instance.instance_id }}/secrets/rotate" class="mt-3 space-y-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <select name="secret_name" class="w-full rounded-lg border border-surface-200 bg-surface-50 px-3 py-2 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white">
                        <option value="POSTGRES_PASSWORD">POSTGRES_PASSWORD</option>
                        <option value="REDIS_PASSWORD">REDIS_PASSWORD</option>
                        <option value="JWT_SECRET">JWT_SECRET</option>
                        <option value="TOTP_ENCRYPTION_KEY">TOTP_ENCRYPTION_KEY (destructive)</option>
                        <option value="OPENBAO_TOKEN">OPENBAO_TOKEN</option>
                    </select>
                    <label class="flex items-center gap-2 text-[12px] text-surface-500 dark:text-surface-400">
                        <input type="checkbox" name="confirm_destructive" value="true" class="h-4 w-4 border-surface-300 text-primary-600 focus:ring-primary-500" />
                        Confirm destructive rotation (required for TOTP key)
                    </label>
                    <button type="submit" class="rounded-lg bg-surface-900 px-4 py-2 text-[13px] font-semibold text-white hover:bg-surface-800 dark:bg-primary-500 dark:text-surface-950 dark:hover:bg-primary-400 transition">Rotate Secret</button>
                </form>
            </div>
            <div class="rounded-lg border border-surface-100 p-4 dark:border-surface-800/60">
                <p class="text-[12px] text-surface-500 dark:text-surface-400">Rotate all secrets</p>
                <form method="POST" action="/instances/{{ instance.instance_id }}/secrets/rotate-all" class="mt-3 space-y-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <label class="flex items-center gap-2 text-[12px] text-surface-500 dark:text-surface-400">
                        <input type="checkbox" name="confirm_destructive" value="true" class="h-4 w-4 border-surface-300 text-primary-600 focus:ring-primary-500" />
                        Confirm destructive rotation (includes TOTP key)
                    </label>
                    <button type="submit" class="rounded-lg border border-surface-200 px-4 py-2 text-[13px] font-semibold text-surface-600 hover:bg-surface-50 dark:border-surface-700 dark:text-surface-300 dark:hover:bg-surface-800 transition">Rotate All</button>
                </form>
            </div>
        </div>

        <div class="mt-6">
            <h3 class="text-[12px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500 mb-3">Rotation History</h3>
            {% if rotation_history %}
            <div class="overflow-x-auto">
                <table class="w-full text-[12px]">
                    <thead>
                        <tr class="border-b border-surface-100 dark:border-surface-800/60 text-left">
                            <th class="pb-2 pr-4 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Secret</th>
                            <th class="pb-2 pr-4 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Status</th>
                            <th class="pb-2 pr-4 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Rotated By</th>
                            <th class="pb-2 pr-4 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Started</th>
                            <th class="pb-2 text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400">Message</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-surface-100 dark:divide-surface-800/60">
                        {% for log in rotation_history %}
                        <tr>
                            <td class="py-2 pr-4 font-mono text-surface-700 dark:text-surface-300">{{ log.secret_name }}</td>
                            <td class="py-2 pr-4">
                                <span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-semibold
                                    {% if log.status.value == 'success' %}bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300{% elif log.status.value == 'failed' %}bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300{% elif log.status.value == 'running' %}bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300{% else %}bg-surface-100 text-surface-600 dark:bg-surface-800 dark:text-surface-300{% endif %}">
                                    {{ log.status.value }}
                                </span>
                            </td>
                            <td class="py-2 pr-4 text-surface-500">{{ log.rotated_by or 'system' }}</td>
                            <td class="py-2 pr-4 text-surface-500">{{ log.started_at.strftime('%Y-%m-%d %H:%M') if log.started_at else '' }}</td>
                            <td class="py-2 text-surface-500">{{ log.error_message or '' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-[12px] text-surface-400">No rotations recorded yet.</p>
            {% endif %}
        </div>
    </div>

    {# ---- BACKUPS TAB ---- #}
    <div x-show="activeTab === 'backups'" x-cloak class="mt-4 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <div class="flex items-center justify-between mb-5">
            <h2 class="text-lg font-display text-surface-700 dark:text-surface-300">Backups</h2>
            <form method="POST" action="/instances/{{ instance.instance_id }}/backup"
                  x-data="{ submitting: false }" @submit="submitting = true">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button type="submit" :disabled="submitting" :class="submitting && 'opacity-60 pointer-events-none'"
                        class="inline-flex items-center gap-2 rounded-lg bg-surface-900 dark:bg-primary-500 px-3 py-2 text-[13px] font-semibold text-white dark:text-surface-950 hover:bg-surface-800 dark:hover:bg-primary-400 transition">
                    <svg x-show="!submitting" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                    <svg x-show="submitting" x-cloak class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span x-text="submitting ? 'Creating...' : 'Create Backup'"></span>
                </button>
            </form>
        </div>
        {% if backups %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-surface-100 dark:border-surface-800/60">
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Type</th>
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Status</th>
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Size</th>
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">File</th>
                        <th class="pb-3 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Created</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-surface-100 dark:divide-surface-800/60">
                    {% for backup in backups %}
                    <tr class="hover:bg-surface-50/60 dark:hover:bg-surface-800/30 transition-colors">
                        <td class="py-3 pr-4">
                            <span class="rounded-md bg-surface-100 px-2 py-0.5 text-[11px] font-medium text-surface-600 dark:bg-surface-800 dark:text-surface-400">{{ backup.backup_type.value }}</span>
                        </td>
                        <td class="py-3 pr-4">
                            {% if backup.status.value == 'completed' %}
                                <span class="inline-flex items-center gap-1.5 text-[11px] font-medium text-emerald-600 dark:text-emerald-400"><span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>Completed</span>
                            {% elif backup.status.value == 'running' %}
                                <span class="inline-flex items-center gap-1.5 text-[11px] font-medium text-blue-600 dark:text-blue-400"><span class="h-1.5 w-1.5 rounded-full bg-blue-500 animate-pulse"></span>Running</span>
                            {% elif backup.status.value == 'failed' %}
                                <span class="inline-flex items-center gap-1.5 text-[11px] font-medium text-red-600 dark:text-red-400"><span class="h-1.5 w-1.5 rounded-full bg-red-500"></span>Failed</span>
                            {% else %}
                                <span class="inline-flex items-center gap-1.5 text-[11px] font-medium text-surface-500"><span class="h-1.5 w-1.5 rounded-full bg-surface-400"></span>{{ backup.status.value|title }}</span>
                            {% endif %}
                        </td>
                        <td class="py-3 pr-4 text-[13px] text-surface-500 dark:text-surface-400">
                            {% if backup.size_bytes %}
                                {% if backup.size_bytes > 1073741824 %}
                                    {{ (backup.size_bytes / 1073741824) | round(1) }} GB
                                {% elif backup.size_bytes > 1048576 %}
                                    {{ (backup.size_bytes / 1048576) | round(1) }} MB
                                {% elif backup.size_bytes > 1024 %}
                                    {{ (backup.size_bytes / 1024) | round(1) }} KB
                                {% else %}
                                    {{ backup.size_bytes }} B
                                {% endif %}
                            {% else %}
                                --
                            {% endif %}
                        </td>
                        <td class="py-3 pr-4 font-mono text-[11px] text-surface-400 dark:text-surface-500 max-w-[200px] truncate">{{ backup.file_path or '--' }}</td>
                        <td class="py-3 text-[13px] text-surface-500 dark:text-surface-400">{{ backup.created_at.strftime('%Y-%m-%d %H:%M') if backup.created_at else '--' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-[13px] text-surface-400 dark:text-surface-500">No backups yet. Create one to get started.</p>
        {% endif %}
    </div>

    {# ---- DOMAINS TAB ---- #}
    <div x-show="activeTab === 'domains'" x-cloak class="mt-4 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-5">Custom Domains</h2>

        {# Add Domain Form #}
        <form method="POST" action="/instances/{{ instance.instance_id }}/domains/add" class="mb-6 flex flex-wrap items-end gap-3"
              x-data="{ submitting: false }" @submit="submitting = true">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <input type="text" name="domain" placeholder="e.g. erp.example.com" required class="flex-1 min-w-[200px] rounded-lg border border-surface-200 bg-surface-50 px-4 py-2.5 text-[13px] dark:border-surface-700 dark:bg-surface-800 dark:text-white focus:border-primary-400 focus:ring-2 focus:ring-primary-200/50 dark:focus:ring-primary-500/20 focus:outline-none transition" />
            <label class="inline-flex items-center gap-2 text-[13px] text-surface-600 dark:text-surface-400">
                <input type="checkbox" name="is_primary" value="true" class="h-4 w-4 rounded border-surface-300 text-primary-600 focus:ring-primary-500" />
                Primary
            </label>
            <button type="submit" :disabled="submitting" :class="submitting && 'opacity-60 pointer-events-none'"
                    class="inline-flex items-center gap-2 rounded-lg bg-surface-900 dark:bg-primary-500 px-4 py-2.5 text-[13px] font-semibold text-white dark:text-surface-950 hover:bg-surface-800 dark:hover:bg-primary-400 transition">
                <svg x-show="!submitting" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                <svg x-show="submitting" x-cloak class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span x-text="submitting ? 'Adding...' : 'Add Domain'"></span>
            </button>
        </form>

        {% if domains %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-surface-100 dark:border-surface-800/60">
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Domain</th>
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Primary</th>
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Status</th>
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Verification Token</th>
                        <th class="pb-3 text-right text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-surface-100 dark:divide-surface-800/60">
                    {% for d in domains %}
                    <tr class="hover:bg-surface-50/60 dark:hover:bg-surface-800/30 transition-colors">
                        <td class="py-3 pr-4 text-[13px] font-medium text-surface-900 dark:text-white">{{ d.domain }}</td>
                        <td class="py-3 pr-4">
                            {% if d.is_primary %}
                                <span class="inline-flex items-center gap-1 rounded-full bg-primary-50 px-2 py-0.5 text-[10px] font-semibold text-primary-700 dark:bg-primary-900/30 dark:text-primary-400">Primary</span>
                            {% else %}
                                <span class="text-[11px] text-surface-400">--</span>
                            {% endif %}
                        </td>
                        <td class="py-3 pr-4">
                            {% if d.status.value == 'verified' %}
                                <span class="inline-flex items-center gap-1.5 text-[11px] font-medium text-emerald-600 dark:text-emerald-400"><span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>Verified</span>
                            {% elif d.status.value == 'pending' %}
                                <span class="inline-flex items-center gap-1.5 text-[11px] font-medium text-amber-600 dark:text-amber-400"><span class="h-1.5 w-1.5 rounded-full bg-amber-400"></span>Pending</span>
                            {% elif d.status.value == 'failed' %}
                                <span class="inline-flex items-center gap-1.5 text-[11px] font-medium text-red-600 dark:text-red-400"><span class="h-1.5 w-1.5 rounded-full bg-red-500"></span>Failed</span>
                            {% else %}
                                <span class="text-[11px] text-surface-500">{{ d.status.value|title }}</span>
                            {% endif %}
                        </td>
                        <td class="py-3 pr-4">
                            {% if d.verification_token %}
                            <code class="rounded bg-surface-100 px-1.5 py-0.5 text-[11px] font-mono text-surface-600 dark:bg-surface-800 dark:text-surface-400 select-all">{{ d.verification_token }}</code>
                            {% else %}
                            <span class="text-[11px] text-surface-400">--</span>
                            {% endif %}
                        </td>
                        <td class="py-3 text-right">
                            <div class="flex items-center justify-end gap-2">
                                {% if d.status.value != 'verified' %}
                                <form method="POST" action="/instances/{{ instance.instance_id }}/domains/{{ d.domain_id }}/verify" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                    <button type="submit" class="rounded-md px-2 py-1 text-[11px] font-medium text-primary-600 hover:bg-primary-50 dark:text-primary-400 dark:hover:bg-primary-900/20 transition">Verify</button>
                                </form>
                                {% endif %}
                                <form method="POST" action="/instances/{{ instance.instance_id }}/domains/{{ d.domain_id }}/delete" onsubmit="return confirm('Remove domain {{ d.domain }}?')" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                    <button type="submit" class="rounded-md px-2 py-1 text-[11px] font-medium text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20 transition">Remove</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-[13px] text-surface-400 dark:text-surface-500">No custom domains configured. Add one above.</p>
        {% endif %}
    </div>

    {# ---- AUDIT LOG TAB ---- #}
    <div x-show="activeTab === 'audit'" x-cloak class="mt-4 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
        <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-5">Audit Log</h2>
        {% if audit_logs %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-surface-100 dark:border-surface-800/60">
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Action</th>
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">User</th>
                        <th class="pb-3 pr-4 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Details</th>
                        <th class="pb-3 text-left text-[10px] font-semibold uppercase tracking-[0.15em] text-surface-400 dark:text-surface-500">Time</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-surface-100 dark:divide-surface-800/60">
                    {% for log in audit_logs %}
                    <tr class="hover:bg-surface-50/60 dark:hover:bg-surface-800/30 transition-colors">
                        <td class="py-3 pr-4">
                            <span class="rounded-md bg-surface-100 px-2 py-0.5 text-[11px] font-medium text-surface-600 dark:bg-surface-800 dark:text-surface-400">{{ log.action }}</span>
                        </td>
                        <td class="py-3 pr-4 text-[13px] text-surface-500 dark:text-surface-400">{{ log.user_name or log.user_id or 'system' }}</td>
                        <td class="py-3 pr-4 text-[11px] text-surface-400 dark:text-surface-500 max-w-[300px] truncate">{{ log.details|tojson if log.details else '--' }}</td>
                        <td class="py-3 text-[13px] text-surface-500 dark:text-surface-400">{{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else '--' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-[13px] text-surface-400 dark:text-surface-500">No audit log entries yet.</p>
        {% endif %}
    </div>
</div>

{# ===== NOTES ===== #}
{% if instance.notes %}
<div class="mt-6 rounded-xl border border-surface-200/80 bg-white p-6 dark:border-surface-800/50 dark:bg-surface-900/80">
    <h2 class="text-lg font-display text-surface-700 dark:text-surface-300 mb-3">Notes</h2>
    <p class="text-[13px] text-surface-500 dark:text-surface-400 whitespace-pre-wrap leading-relaxed">{{ instance.notes }}</p>
</div>
{% endif %}
{% endblock %}
